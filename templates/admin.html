<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Admin - Reservas Chromebook</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
  <h3 class="text-center mb-4">Administração - Agenda do dia {{ data.strftime('%d/%m/%Y') }}</h3>

    <!-- Barra de ações -->
  <div class="d-flex justify-content-center gap-2 mb-3">
    <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-sm">Sair</a>
  </div>

  <!-- Mensagens -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Navegação entre dias -->
  <div class="d-flex justify-content-center gap-2 mb-3">
    <a href="{{ url_for('admin', data=(data - timedelta(days=1)).strftime('%Y-%m-%d')) }}" 
      class="btn btn-outline-secondary btn-sm">← Dia anterior</a>

    <a href="{{ url_for('calendar') }}" 
      class="btn btn-outline-primary btn-sm">Voltar ao calendário</a>

    <a href="{{ url_for('admin', data=(data + timedelta(days=1)).strftime('%Y-%m-%d')) }}" 
      class="btn btn-outline-secondary btn-sm">Próximo dia →</a>
  </div>

  <!-- Botões de bloqueio/desbloqueio -->
  <div class="d-flex justify-content-center gap-2 mb-3">
    <form method="POST" action="{{ url_for('bloquear_data') }}">
      <input type="hidden" name="data" value="{{ data.strftime('%Y-%m-%d') }}">
      <button type="submit" class="btn btn-danger btn-sm">Bloquear dia</button>
    </form>
    <form method="POST" action="{{ url_for('desbloquear_data') }}">
      <input type="hidden" name="data" value="{{ data.strftime('%Y-%m-%d') }}">
      <button type="submit" class="btn btn-success btn-sm">Desbloquear dia</button>
    </form>
  </div>
  <!-- CARD MATUTINO -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white text-center">
      <h3 class="fw-bold fs-2">Matutino</h3>
    </div>
    <div class="card-body">

      <!-- MATUTINO SUPERIOR -->
      <table class="table table-bordered text-center align-middle">
        <thead>
          <tr class="table-primary">
            <th colspan="3" class="text-center fw-bold">Piso Superior</th>
          </tr>
          <tr class="table-primary">
            <th>Aula</th>
            <th>Carrinho Chrome 1</th>
            <th>Carrinho Chrome 2</th>
          </tr>
        </thead>
        <tbody>
          {% for aula in range(1,6) %}
          <tr>
            <td><b>{{ aula }}</b></td>
            {% for vaga in [1,2] %}
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Matutino")|selectattr("piso","equalto","Superior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",vaga)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <!-- Formulário -->
                  <form method="POST" action="{{ url_for('agendar_admin', id=h.id, data=data.strftime('%Y-%m-%d')) }}"
                        class="d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2" style="flex-grow:1;">
                      <input type="text" name="nome" placeholder="Nome"
                             class="form-control form-control-sm" style="width:400px;" required>
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control form-control-sm" style="width:80px;" required>
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary">Agendar</button>
                  </form>
                {% elif h.user_id %}
                  <!-- Usuário comum -->
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-semibold" style="max-width:300px;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                      <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                    </form>
                  </div>
                {% elif h.nome %}
                  <!-- Admin -->
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-semibold" style="max-width:300px;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                      <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                    </form>
                  </div>
                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <!-- MATUTINO INFERIOR -->
      <table class="table table-bordered text-center align-middle mt-4">
        <thead>
          <tr class="table-primary">
            <th colspan="3" class="text-center fw-bold">Piso Inferior</th>
          </tr>
          <tr class="table-primary">
            <th>Aula</th>
            <th>Carrinho Chrome 1</th>
            <th>Carrinho Chrome 2</th>
          </tr>
        </thead>
        <tbody>
          {% for aula in range(1,6) %}
          <tr>
            <td><b>{{ aula }}</b></td>
            {% for vaga in [1,2] %}
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Matutino")|selectattr("piso","equalto","Inferior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",vaga)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <!-- Formulário -->
                  <form method="POST" action="{{ url_for('agendar_admin', id=h.id, data=data.strftime('%Y-%m-%d')) }}"
                        class="d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2" style="flex-grow:1;">
                      <input type="text" name="nome" placeholder="Nome"
                             class="form-control form-control-sm" style="width:400px;" required>
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control form-control-sm" style="width:80px;" required>
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary">Agendar</button>
                  </form>
                {% elif h.user_id %}
                  <!-- Usuário comum -->
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-semibold" style="max-width:300px;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                      <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                    </form>
                  </div>
                {% elif h.nome %}
                  <!-- Admin -->
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-semibold" style="max-width:300px;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                      <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                    </form>
                  </div>
                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div> <!-- fecha card-body Matutino -->
  </div> <!-- fecha card Matutino -->
  <!-- CARD VESPERTINO -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white text-center">
      <h3 class="fw-bold fs-2">Vespertino</h3>
    </div>
    <div class="card-body">

      <!-- VESPERTINO SUPERIOR -->
      <table class="table table-bordered text-center align-middle">
        <thead>
          <tr class="table-primary">
            <th colspan="3" class="text-center fw-bold">Piso Superior</th>
          </tr>
          <tr class="table-primary">
            <th>Aula</th>
            <th>Carrinho Chrome 1</th>
            <th>Carrinho Chrome 2</th>
          </tr>
        </thead>
        <tbody>
          {% for aula in range(1,6) %}
          <tr>
            <td><b>{{ aula }}</b></td>
            {% for vaga in [1,2] %}
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Vespertino")|selectattr("piso","equalto","Superior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",vaga)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <!-- Formulário -->
                  <form method="POST" action="{{ url_for('agendar_admin', id=h.id, data=data.strftime('%Y-%m-%d')) }}"
                        class="d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2" style="flex-grow:1;">
                      <input type="text" name="nome" placeholder="Nome"
                             class="form-control form-control-sm" style="width:400px;" required>
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control form-control-sm" style="width:80px;" required>
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary">Agendar</button>
                  </form>
                {% elif h.user_id %}
                  <!-- Usuário comum -->
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-semibold" style="max-width:300px;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                      <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                    </form>
                  </div>
                {% elif h.nome %}
                  <!-- Admin -->
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-semibold" style="max-width:300px;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                      <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                    </form>
                  </div>
                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <!-- VESPERTINO INFERIOR -->
      <table class="table table-bordered text-center align-middle mt-4">
        <thead>
          <tr class="table-primary">
            <th colspan="3" class="text-center fw-bold">Piso Inferior</th>
          </tr>
          <tr class="table-primary">
            <th>Aula</th>
            <th>Carrinho Chrome 1</th>
            <th>Carrinho Chrome 2</th>
          </tr>
        </thead>
        <tbody>
          {% for aula in range(1,6) %}
          <tr>
            <td><b>{{ aula }}</b></td>
            {% for vaga in [1,2] %}
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Vespertino")|selectattr("piso","equalto","Inferior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",vaga)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <!-- Formulário -->
                  <form method="POST" action="{{ url_for('agendar_admin', id=h.id, data=data.strftime('%Y-%m-%d')) }}"
                        class="d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2" style="flex-grow:1;">
                      <input type="text" name="nome" placeholder="Nome"
                             class="form-control form-control-sm" style="width:400px;" required>
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control form-control-sm" style="width:80px;" required>
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary">Agendar</button>
                  </form>
                {% elif h.user_id %}
                  <!-- Usuário comum -->
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-semibold" style="max-width:300px;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                      <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                    </form>
                  </div>
                {% elif h.nome %}
                  <!-- Admin -->
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-semibold" style="max-width:300px;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                      <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                    </form>
                  </div>
                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div> <!-- fecha card-body Vespertino -->
  </div> <!-- fecha card Vespertino -->
</div> <!-- fecha container -->

</body>
</html>