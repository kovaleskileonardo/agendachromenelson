<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Agenda - Reservas Chromebook</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
  <h3 class="text-center mb-4">Agenda do dia {{ data.strftime('%d/%m/%Y') }}</h3>

  <!-- Barra de ações -->
  <div class="d-flex justify-content-center gap-2 mb-3">
    <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-sm">Sair</a>
  </div>

  <!-- Mensagens -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Navegação entre dias -->
  <div class="d-flex justify-content-center gap-2 mb-3">
    <a href="{{ url_for('agenda', data=(data - timedelta(days=1)).strftime('%Y-%m-%d')) }}" 
      class="btn btn-outline-secondary btn-sm">← Dia anterior</a>

    <a href="{{ url_for('calendar') }}" 
      class="btn btn-outline-primary btn-sm">Voltar ao calendário</a>

    <a href="{{ url_for('agenda', data=(data + timedelta(days=1)).strftime('%Y-%m-%d')) }}" 
      class="btn btn-outline-secondary btn-sm">Próximo dia →</a>
  </div>

  <!-- CARD MATUTINO -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white text-center">
      <h3 class="fw-bold fs-2">Matutino</h3>
    </div>
    <div class="card-body">

      <!-- MATUTINO SUPERIOR -->
      <table class="table table-bordered text-center align-middle">
        <thead>
          <tr class="table-primary">
            <th colspan="3" class="text-center fw-bold">Piso Superior</th>
          </tr>
          <tr class="table-primary">
            <th>Aula</th>
            <th style="width:50%;">Carrinho Chrome 1</th>
            <th style="width:50%;">Carrinho Chrome 2</th>
          </tr>
        </thead>
        <tbody>
          {% for aula in range(1,6) %}
          <tr>
            <td><b>{{ aula }}</b></td>
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Matutino")|selectattr("piso","equalto","Superior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",1)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <form method="POST" action="{{ url_for('agendar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                    <div class="input-group input-group-sm">
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control" required>
                      <button type="submit" class="btn btn-primary">Agendar</button>
                    </div>
                  </form>

                {% elif h.user_id %}
                  <div class="d-flex justify-content-between align-items-center 
                              {% if h.user_id == current_user.id %} bg-success-subtle {% endif %} 
                              {% if current_user.is_admin %} bg-success-subtle {% endif %}"
                      style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    {% if h.user_id == current_user.id or current_user.is_admin %}
                      <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                        <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                      </form>
                    {% endif %}
                  </div>

                {% elif h.nome %}
                  <div class="d-flex justify-content-between align-items-center" style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                  </div>

                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Matutino")|selectattr("piso","equalto","Superior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",2)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <form method="POST" action="{{ url_for('agendar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                    <div class="input-group input-group-sm">
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control" required>
                      <button type="submit" class="btn btn-primary">Agendar</button>
                    </div>
                  </form>

                {% elif h.user_id %}
                  <div class="d-flex justify-content-between align-items-center 
                              {% if h.user_id == current_user.id %} bg-success-subtle {% endif %} 
                              {% if current_user.is_admin %} bg-success-subtle {% endif %}"
                      style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    {% if h.user_id == current_user.id or current_user.is_admin %}
                      <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                        <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                      </form>
                    {% endif %}
                  </div>

                {% elif h.nome %}
                  <div class="d-flex justify-content-between align-items-center" style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                  </div>

                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <!-- MATUTINO INFERIOR -->
      <table class="table table-bordered text-center align-middle mt-4">
        <thead>
          <tr class="table-primary">
            <th colspan="3" class="text-center fw-bold">Piso Inferior</th>
          </tr>
          <tr class="table-primary">
            <th>Aula</th>
            <th style="width:50%;">Carrinho Chrome 1</th>
            <th style="width:50%;">Carrinho Chrome 2</th>
          </tr>
        </thead>
        <tbody>
          {% for aula in range(1,6) %}
          <tr>
            <td><b>{{ aula }}</b></td>
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Matutino")|selectattr("piso","equalto","Inferior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",1)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <form method="POST" action="{{ url_for('agendar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                    <div class="input-group input-group-sm">
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control" required>
                      <button type="submit" class="btn btn-primary">Agendar</button>
                    </div>
                  </form>

                {% elif h.user_id %}
                  <div class="d-flex justify-content-between align-items-center 
                              {% if h.user_id == current_user.id %} bg-success-subtle {% endif %} 
                              {% if current_user.is_admin %} bg-success-subtle {% endif %}"
                      style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    {% if h.user_id == current_user.id or current_user.is_admin %}
                      <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                        <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                      </form>
                    {% endif %}
                  </div>

                {% elif h.nome %}
                  <div class="d-flex justify-content-between align-items-center" style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                  </div>

                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Matutino")|selectattr("piso","equalto","Inferior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",2)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <form method="POST" action="{{ url_for('agendar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                    <div class="input-group input-group-sm">
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control" required>
                      <button type="submit" class="btn btn-primary">Agendar</button>
                    </div>
                  </form>

                {% elif h.user_id %}
                  <div class="d-flex justify-content-between align-items-center 
                              {% if h.user_id == current_user.id %} bg-success-subtle {% endif %} 
                              {% if current_user.is_admin %} bg-success-subtle {% endif %}"
                      style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    {% if h.user_id == current_user.id or current_user.is_admin %}
                      <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                        <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                      </form>
                    {% endif %}
                  </div>

                {% elif h.nome %}
                  <div class="d-flex justify-content-between align-items-center" style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                  </div>

                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div> <!-- fecha card-body Matutino -->
  </div> <!-- fecha card Matutino -->

  <!-- CARD VESPERTINO -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white text-center">
      <h3 class="fw-bold fs-2">Vespertino</h3>
    </div>
    <div class="card-body">

      <!-- VESPERTINO SUPERIOR -->
      <table class="table table-bordered text-center align-middle">
        <thead>
          <tr class="table-primary">
            <th colspan="3" class="text-center fw-bold">Piso Superior</th>
          </tr>
          <tr class="table-primary">
            <th>Aula</th>
            <th style="width:50%;">Carrinho Chrome 1</th>
            <th style="width:50%;">Carrinho Chrome 2</th>
          </tr>
        </thead>
        <tbody>
          {% for aula in range(1,6) %}
          <tr>
            <td><b>{{ aula }}</b></td>
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Vespertino")|selectattr("piso","equalto","Superior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",1)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <form method="POST" action="{{ url_for('agendar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                    <div class="input-group input-group-sm">
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control" required>
                      <button type="submit" class="btn btn-primary">Agendar</button>
                    </div>
                  </form>

                {% elif h.user_id %}
                  <div class="d-flex justify-content-between align-items-center 
                              {% if h.user_id == current_user.id %} bg-success-subtle {% endif %} 
                              {% if current_user.is_admin %} bg-success-subtle {% endif %}"
                      style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    {% if h.user_id == current_user.id or current_user.is_admin %}
                      <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                        <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                      </form>
                    {% endif %}
                  </div>

                {% elif h.nome %}
                  <div class="d-flex justify-content-between align-items-center" style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                  </div>

                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Vespertino")|selectattr("piso","equalto","Superior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",2)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <form method="POST" action="{{ url_for('agendar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                    <div class="input-group input-group-sm">
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control" required>
                      <button type="submit" class="btn btn-primary">Agendar</button>
                    </div>
                  </form>

                {% elif h.user_id %}
                  <div class="d-flex justify-content-between align-items-center 
                              {% if h.user_id == current_user.id %} bg-success-subtle {% endif %} 
                              {% if current_user.is_admin %} bg-success-subtle {% endif %}"
                      style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    {% if h.user_id == current_user.id or current_user.is_admin %}
                      <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                        <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                      </form>
                    {% endif %}
                  </div>

                {% elif h.nome %}
                  <div class="d-flex justify-content-between align-items-center" style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                  </div>

                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- VESPERTINO INFERIOR -->
      <table class="table table-bordered text-center align-middle mt-4">
        <thead>
          <tr class="table-primary">
            <th colspan="3" class="text-center fw-bold">Piso Inferior</th>
          </tr>
          <tr class="table-primary">
            <th>Aula</th>
            <th style="width:50%;">Carrinho Chrome 1</th>
            <th style="width:50%;">Carrinho Chrome 2</th>
          </tr>
        </thead>
        <tbody>
          {% for aula in range(1,6) %}
          <tr>
            <td><b>{{ aula }}</b></td>
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Vespertino")|selectattr("piso","equalto","Inferior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",1)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <form method="POST" action="{{ url_for('agendar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                    <div class="input-group input-group-sm">
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control" required>
                      <button type="submit" class="btn btn-primary">Agendar</button>
                    </div>
                  </form>

                {% elif h.user_id %}
                  <div class="d-flex justify-content-between align-items-center 
                              {% if h.user_id == current_user.id %} bg-success-subtle {% endif %} 
                              {% if current_user.is_admin %} bg-success-subtle {% endif %}"
                      style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    {% if h.user_id == current_user.id or current_user.is_admin %}
                      <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                        <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                      </form>
                    {% endif %}
                  </div>

                {% elif h.nome %}
                  <div class="d-flex justify-content-between align-items-center" style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                  </div>

                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
            <td>
              {% set h = horarios|selectattr("periodo","equalto","Vespertino")|selectattr("piso","equalto","Inferior")|selectattr("aula","equalto",aula)|selectattr("vaga","equalto",2)|first %}
              {% if h %}
                {% if not h.user_id and not h.bloqueado and not h.nome %}
                  <form method="POST" action="{{ url_for('agendar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                    <div class="input-group input-group-sm">
                      <input type="text" name="turma" placeholder="Turma"
                             class="form-control" required>
                      <button type="submit" class="btn btn-primary">Agendar</button>
                    </div>
                  </form>

                {% elif h.user_id %}
                  <div class="d-flex justify-content-between align-items-center 
                              {% if h.user_id == current_user.id %} bg-success-subtle {% endif %} 
                              {% if current_user.is_admin %} bg-success-subtle {% endif %}"
                      style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.user.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                    {% if h.user_id == current_user.id or current_user.is_admin %}
                      <form method="POST" action="{{ url_for('cancelar', id=h.id, data=data.strftime('%Y-%m-%d')) }}">
                        <button type="submit" class="btn btn-sm btn-warning">Cancelar</button>
                      </form>
                    {% endif %}
                  </div>

                {% elif h.nome %}
                  <div class="d-flex justify-content-between align-items-center" style="white-space:nowrap;">
                    <div class="fw-semibold text-truncate" style="max-width:70%;">
                      {{ h.nome }} <span class="fw-bold">({{ h.turma }})</span>
                    </div>
                  </div>

                {% elif h.bloqueado %}
                  <span class="badge bg-secondary">Bloqueado</span>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div> <!-- fecha card-body Vespertino -->
  </div> <!-- fecha card Vespertino -->
</div> <!-- fecha container -->

</body>
</html>